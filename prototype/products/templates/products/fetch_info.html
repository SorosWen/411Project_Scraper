<h1> Product Search Page </h1>

<form action="/products/" method="POST">
    {% csrf_token %}
    <label for="product_name">Please enter a product name: </label>
    <input type="text" id = "product_name" name="product_name" required>

    <button type="submit" value="Submit">Search</button>
</form>

{% if product_name %} 
<body>
    <h1>Top 3 Search Results for {{ product_name }}</h1>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <div id ='updateDiv'></div>
    <p id="demo"></p>
        <script>

        // change queryString to whatever search term the user enters
        var queryString = '{{ product_name }}'
        var googleSearchAPIKey = '540a75178a80616c693cbade72c360e8'

        var ebaySearchAPIKey = '71F4D87D51294D71B6A9E61373597E61'
        var ebayReviewID = ''
    
        var googleStaticURL = 'http://api.serpstack.com/search?access_key=' + googleSearchAPIKey + '&query='+
            queryString + ' price=google&location=newyork&google_domain=google.com'
        
        var ebayStaticURL = 'https://api.countdownapi.com/request?api_key=' + ebaySearchAPIKey +
            '&type=search&ebay_domain=ebay.com&search_term=' + queryString + '&num=25'


        // get the JSON and loop through the search results and display the first 3
        $.getJSON(googleStaticURL, function(data) {
            console.log(data);
            for (i = 0; i < 3; i++) {
                var k = i + 1;
                newParagraph = document.createElement('p');
                newParagraph.textContent = k.toString() + ". " + data.organic_results[i].title;
                document.getElementById("updateDiv").appendChild(newParagraph);

                newParagraph = document.createElement('p');
                newParagraph.textContent = " " + data.organic_results[i].url;
                document.getElementById("updateDiv").appendChild(newParagraph);
            }
        });

        // perform two consecutive API searches
        function ebayResultandReviews(){
            // get the ebay results first
            $.getJSON(ebayStaticURL, function(data) {
                ebayReviewID = data.search_results[0].epid;
                console.log(data);
                for (i = 0; i < 3; i++) {
                    var k = i + 1;
                    newParagraph = document.createElement('p');
                    newParagraph.textContent = k.toString() + ". " + data.search_results[i].title;
                    document.getElementById("updateDiv").appendChild(newParagraph);

                    newParagraph = document.createElement('p');
                    newParagraph.textContent = " " + data.search_results[i].link;
                    document.getElementById("updateDiv").appendChild(newParagraph);
                }
            }).done(function () {
                // wait till results and item id is back and do search on reviews
                var ebayReviewURL = 'https://api.countdownapi.com/request?api_key=' + ebaySearchAPIKey + 
                '&type=reviews&ebay_domain=ebay.com&epid=' + ebayReviewID + '&condition=all'
            
                $.getJSON(ebayReviewURL, function(data) {
                    console.log(data);
                    newParagraph = document.createElement('h2');
                    newParagraph.textContent = "Reviews"

                    newParagraph = document.createElement('p');
                    newParagraph.textContent = " " + data.top_favourable.title;
                    document.getElementById("updateDiv").appendChild(newParagraph);

                    newParagraph = document.createElement('p');
                    newParagraph.textContent = " " + data.top_favourable.body;
                    document.getElementById("updateDiv").appendChild(newParagraph);
                    
                });
            }); 
        }
        $(document).ready(function() {
            ebayResultandReviews();
        });

        
        </script>
  
  </body>
{% endif %}
