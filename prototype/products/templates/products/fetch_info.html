{% load static %}

{% include 'products/messages.html' %}

<!--Navbar-->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Navbar</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarText">
      <ul class="navbar-nav mr-auto">
        {% if user.is_authenticated %}
        
        <li class="nav-item">
          <a class="nav-link" href="/products/logout">Logout</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Welcome, {{user.username}}</a>
        </li>
  
        {% else %}
  
        <li class="nav-item">
          <a class="nav-link" href="/products/login">Login</a>
        </li>
  
        {% endif %}
      </ul>
    </div>
  </nav>
  

<h1> Product Search Page </h1>
<head>
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>

<form action="/products/" method="POST">
    {% csrf_token %}
    <label for="product_name">Please enter a product name: </label>
    <input type="text" id = "product_name" name="product_name" required>

    <button type="submit" value="Submit">Search</button>
</form>


{% if product_name %} 
<body>
    <h1>Top 6 Search Results for {{ product_name }}</h1>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <div id ='updateDiv'></div>
    <p id="demo"></p>
        <script>

        // change queryString to whatever search term the user enters
        var queryString = '{{ product_name }}'
        var googleSearchAPIKey = '540a75178a80616c693cbade72c360e8'

        var ebaySearchAPIKey = '59E8F264F6D84373B5FD933CA7CFDF5D'
        var ebayReviewID = ''
    
        var googleStaticURL = 'http://api.serpstack.com/search?access_key=' + googleSearchAPIKey + '&query='+
            queryString + ' price=google&location=newyork&google_domain=google.com'
        
        var ebayStaticURL = 'https://api.countdownapi.com/request?api_key=' + ebaySearchAPIKey +
            '&type=search&ebay_domain=ebay.com&search_term=' + queryString + '&num=25'

        let left = document.createElement('div');
        left.className = 'split left';
        document.body.appendChild(left);

        let leftcenter = document.createElement('div');
        leftcenter.className = 'centered';
        left.appendChild(leftcenter);

        let right = document.createElement('div');
        right.className = 'split right';
        document.body.appendChild(right);

        let rightcenter = document.createElement('div');
        rightcenter.className = 'centered';
        right.appendChild(rightcenter);

        
        // perform two consecutive API searches
        function ebayResultandReviews(){
            
            $.getJSON(googleStaticURL, function(data) {
            console.log(data);
            let div = document.createElement('div');
            div.id = 'googleResults';
            leftcenter.appendChild(div);
            let h4 = document.createElement('h4');
            h4.textContent = 'What we found on Google:';

            div.appendChild(h4);
            for (i = 0; i < 3; i++) {
                var k = i + 1;
                newParagraph = document.createElement('p');
                newParagraph.textContent = k.toString() + ". " + data.organic_results[i].title;
                div.appendChild(newParagraph);

                newParagraph = document.createElement('p');
                newParagraph.textContent = " " + data.organic_results[i].url;
                div.appendChild(newParagraph);
            }
        });
        
            // get the ebay results first
            $.getJSON(ebayStaticURL, function(data) {
                ebayReviewID = data.search_results[0].epid;
                console.log(data);
                
                let div = document.createElement('div');
                div.id = 'ebayResults';
                leftcenter.appendChild(div);
                let h4 = document.createElement('h4');
                h4.textContent = 'What we found on eBay:';
                div.appendChild(h4);
                
                for (i = 0; i < 3; i++) {
                    var k = i + 1;
                    newParagraph = document.createElement('p');
                    newParagraph.textContent = k.toString() + ". " + data.search_results[i].title;
                    div.appendChild(newParagraph);

                    newParagraph = document.createElement('p');
                    newParagraph.textContent = "Price: " + data.search_results[i].price.raw;
                    div.appendChild(newParagraph);

                    newParagraph = document.createElement('p');
                    newParagraph.textContent = data.search_results[i].link;
                    div.appendChild(newParagraph);

                }
            }).done(function () {
                // wait till results and item id is back and do search on reviews
                var ebayReviewURL = 'https://api.countdownapi.com/request?api_key=' + ebaySearchAPIKey + 
                '&type=reviews&ebay_domain=ebay.com&epid=' + ebayReviewID + '&condition=all'
            
                $.getJSON(ebayReviewURL, function(data) {
                    console.log(data);
                    let div = document.createElement('div');
                    div.id = 'reviews';
                    rightcenter.appendChild(div);

                    // header
                    let h2 = document.createElement('h2');
                    h2.textContent = 'Reviews on ' + queryString + ': ' + " Average Ratings: " + data.summary.rating;
                    div.appendChild(h2);
                    

                    // title + ratings
                    let h3 = document.createElement('h4');
                    h3.textContent = data.top_favourable.title;
                    div.appendChild(h3);

                    newParagraph = document.createElement('p');
                    newParagraph.textContent = data.top_favourable.body;
                    div.appendChild(newParagraph);

                    newParagraph = document.createElement('h5');
                    newParagraph.textContent = "    - Item reviewed by " + data.top_favourable.profile.name;
                    div.appendChild(newParagraph);

                    // Second Reviewer
                    let review1 = document.createElement('h4');
                    review1.textContent = data.reviews[1].title + " User Rating: " + data.reviews[1].rating;
                    div.appendChild(review1);
                    newParagraph = document.createElement('p');
                    newParagraph.textContent = data.reviews[1].body;
                    div.appendChild(newParagraph);
                    newParagraph = document.createElement('h5');
                    newParagraph.textContent = "    - Item reviewed by " + data.reviews[1].profile.name;
                    div.appendChild(newParagraph);

                    // Third Reviewer
                    let review2 = document.createElement('h4');
                    review2.textContent = data.reviews[2].title + " User Rating: " + data.reviews[2].rating;
                    div.appendChild(review2);
                    newParagraph = document.createElement('p');
                    newParagraph.textContent = data.reviews[2].body;
                    div.appendChild(newParagraph);
                    newParagraph = document.createElement('h5');
                    newParagraph.textContent = "    - Item reviewed by " + data.reviews[2].profile.name;
                    div.appendChild(newParagraph);
                    
                });
            }); 
            
        }
        $(document).ready(function() {
            ebayResultandReviews();
        });

        
        </script>
  
  </body>
{% endif %}
